"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[2568],{3031(e,n,i){i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>r,metadata:()=>t,toc:()=>o});const t=JSON.parse('{"id":"bulk-image-patching","title":"Bulk Image Patching","description":"This guide covers Copa\'s bulk image patching capability for patching many images from a single declarative config. Define repositories, tag discovery rules, and output tagging in YAML, then execute everything with one command.","source":"@site/versioned_docs/version-v0.13.x/bulk-image-patching.md","sourceDirName":".","slug":"/bulk-image-patching","permalink":"/copacetic/website/bulk-image-patching","draft":false,"unlisted":false,"tags":[],"version":"v0.13.x","frontMatter":{"title":"Bulk Image Patching"},"sidebar":"sidebar","previous":{"title":"Scanner Plugins","permalink":"/copacetic/website/scanner-plugins"},"next":{"title":"Multi-Platform Patching","permalink":"/copacetic/website/multiplatform-patching"}}');var a=i(4848),s=i(8453);const r={title:"Bulk Image Patching"},l=void 0,c={},o=[{value:"Overview",id:"overview",level:2},{value:"PatchConfig Schema",id:"patchconfig-schema",level:2},{value:"Tag Strategies",id:"tag-strategies",level:3},{value:"Multi\u2011Platform Behavior",id:"multiplatform-behavior",level:2},{value:"Running Bulk Patching",id:"running-bulk-patching",level:2},{value:"Command Reference (Bulk Mode)",id:"command-reference-bulk-mode",level:3},{value:"Behavior and Output",id:"behavior-and-output",level:2},{value:"Examples",id:"examples",level:2},{value:"Nightly sweep",id:"nightly-sweep",level:3},{value:"Keep base images fresh",id:"keep-base-images-fresh",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.p,{children:"This guide covers Copa's bulk image patching capability for patching many images from a single declarative config. Define repositories, tag discovery rules, and output tagging in YAML, then execute everything with one command."}),"\n",(0,a.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,a.jsxs)(n.p,{children:["Bulk mode adds a ",(0,a.jsx)(n.code,{children:"--config"})," flag to ",(0,a.jsx)(n.code,{children:"copa patch"}),". Instead of targeting one image, Copa reads a PatchConfig file, discovers tags (via list, pattern, or latest), and runs patch jobs concurrently. This is ideal for nightly sweeps, release hardening, or keeping base images up to date."]}),"\n",(0,a.jsx)(n.admonition,{type:"note",children:(0,a.jsx)(n.p,{children:"Bulk patching uses Copa's comprehensive update-all flow. Vulnerability report\u2013driven bulk patching is planned for a future release."})}),"\n",(0,a.jsx)(n.h2,{id:"patchconfig-schema",children:"PatchConfig Schema"}),"\n",(0,a.jsx)(n.p,{children:"Top\u2011level fields:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:'# copa-bulk-config.yaml\napiVersion: copa.sh/v1alpha1\nkind: PatchConfig\n\nimages:\n  - name: "nginx"\n    image: "docker.io/library/nginx"\n    tags:\n      strategy: "pattern"              # pattern | latest | list\n      pattern: "^1\\\\.2[0-9]\\\\.[0-9]+$"\n      maxTags: 3                        # optional cap\n      exclude: ["1.20.0", "1.20.1"]   # optional skip list\n    target:\n      # Defaults to {{ .SourceTag }}-patched if omitted\n      tag: "{{ .SourceTag }}-patched"\n\n  - name: "python"\n    image: "docker.io/library/python"\n    tags:\n      strategy: "list"\n      list: ["3.9.18", "3.10.13", "3.11.7"]\n    # Optional per-image platform filter for multi-arch\n    platforms: ["linux/amd64", "linux/arm64"]\n\n  - name: "alpine"\n    image: "docker.io/library/alpine"\n    tags:\n      strategy: "latest"\n'})}),"\n",(0,a.jsx)(n.h3,{id:"tag-strategies",children:"Tag Strategies"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"strategy: list"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Patch exactly the tags provided in ",(0,a.jsx)(n.code,{children:"list"}),"."]}),"\n",(0,a.jsx)(n.li,{children:"Missing tags are logged as warnings and skipped."}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"strategy: pattern"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Discover all tags from the registry, filter with a regex ",(0,a.jsx)(n.code,{children:"pattern"}),"."]}),"\n",(0,a.jsx)(n.li,{children:"Sort with semantic versioning when possible; fall back to lexical as needed."}),"\n",(0,a.jsxs)(n.li,{children:["Apply ",(0,a.jsx)(n.code,{children:"maxTags"})," cap and ",(0,a.jsx)(n.code,{children:"exclude"})," list before patching."]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"strategy: latest"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Select a single highest version by semantic versioning (or registry timestamp fallback for non\u2011semver) and patch only that tag."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"multiplatform-behavior",children:"Multi\u2011Platform Behavior"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Automatic detection: If a discovered tag is multi\u2011arch, Copa patches all platforms by default, or only those listed in ",(0,a.jsx)(n.code,{children:"platforms"})," for that image spec."]}),"\n",(0,a.jsxs)(n.li,{children:["Targeting platforms: Use ",(0,a.jsx)(n.code,{children:"platforms"})," in the YAML to restrict which platforms are patched; other platforms are preserved unchanged in the final manifest."]}),"\n",(0,a.jsxs)(n.li,{children:["End result: Patched images are pushed when ",(0,a.jsx)(n.code,{children:"--push"})," is set, or exported to OCI layout with ",(0,a.jsx)(n.code,{children:"--oci-dir"})," when not pushing."]}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["See also: ",(0,a.jsx)(n.a,{href:"/copacetic/website/multiplatform-patching",children:"Multi\u2011Platform Patching"})]}),"\n",(0,a.jsx)(n.h2,{id:"running-bulk-patching",children:"Running Bulk Patching"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# Patch everything defined in the config and push results\ncopa patch --config ./copa-bulk-config.yaml --push --timeout 15m\n\n# Offline export (no push): write multi\u2011arch index/manifest as OCI layout\ncopa patch --config ./copa-bulk-config.yaml --oci-dir ./out\n"})}),"\n",(0,a.jsx)(n.h3,{id:"command-reference-bulk-mode",children:"Command Reference (Bulk Mode)"}),"\n",(0,a.jsxs)(n.table,{children:[(0,a.jsx)(n.thead,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.th,{children:"Flag"}),(0,a.jsx)(n.th,{children:"Description"})]})}),(0,a.jsxs)(n.tbody,{children:[(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"--config"})}),(0,a.jsx)(n.td,{children:"Path to PatchConfig YAML. Enables bulk mode."})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"--push"})}),(0,a.jsx)(n.td,{children:"Push patched images and (if multi\u2011arch) the manifest list to the registry"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"--timeout"})}),(0,a.jsxs)(n.td,{children:["Per\u2011job timeout (e.g., ",(0,a.jsx)(n.code,{children:"15m"}),")"]})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"--ignore-errors"})}),(0,a.jsx)(n.td,{children:"Continue processing other jobs if one fails"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:(0,a.jsx)(n.code,{children:"--oci-dir"})}),(0,a.jsx)(n.td,{children:"Export patched image(s) as an OCI layout instead of pushing"})]})]})]}),"\n",(0,a.jsx)(n.p,{children:"Restrictions in bulk mode:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"--config"})," cannot be combined with ",(0,a.jsx)(n.code,{children:"--image"}),", ",(0,a.jsx)(n.code,{children:"--report"}),", or ",(0,a.jsx)(n.code,{children:"--tag"}),"."]}),"\n",(0,a.jsxs)(n.li,{children:["Global flags like ",(0,a.jsx)(n.code,{children:"--push"}),", ",(0,a.jsx)(n.code,{children:"--timeout"}),", ",(0,a.jsx)(n.code,{children:"--ignore-errors"}),", and ",(0,a.jsx)(n.code,{children:"--oci-dir"})," apply to every job defined by the config."]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"behavior-and-output",children:"Behavior and Output"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Concurrency: Copa runs a worker pool to process many images/tags in parallel without overwhelming the host."}),"\n",(0,a.jsxs)(n.li,{children:["Target tags: If ",(0,a.jsx)(n.code,{children:"target.tag"})," is omitted, Copa uses ",(0,a.jsx)(n.code,{children:"{{ .SourceTag }}-patched"})," (e.g., ",(0,a.jsx)(n.code,{children:"1.21.6-patched"}),")."]}),"\n",(0,a.jsxs)(n.li,{children:["Summary: At the end, Copa prints a summary table listing each ",(0,a.jsx)(n.code,{children:"image:tag"}),", status, and details."]}),"\n",(0,a.jsxs)(n.li,{children:["Failures: Individual job failures are reported; with ",(0,a.jsx)(n.code,{children:"--ignore-errors"}),", other jobs continue."]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"examples",children:"Examples"}),"\n",(0,a.jsx)(n.h3,{id:"nightly-sweep",children:"Nightly sweep"}),"\n",(0,a.jsx)(n.p,{children:"Patch the three latest matching minor versions for nginx and all specified python versions, push results:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"copa patch --config ./copa-bulk-config.yaml --push --timeout 20m\n"})}),"\n",(0,a.jsx)(n.h3,{id:"keep-base-images-fresh",children:"Keep base images fresh"}),"\n",(0,a.jsxs)(n.p,{children:["Use ",(0,a.jsx)(n.code,{children:"pattern"})," with ",(0,a.jsx)(n.code,{children:"maxTags"})," to continuously patch the latest LTS tags. Example pattern for Ubuntu LTS: ",(0,a.jsx)(n.code,{children:"^(20|22|24)\\.04$"}),"."]}),"\n",(0,a.jsx)(n.admonition,{type:"warning",children:(0,a.jsx)(n.p,{children:"Build attestations, signatures, and OCI referrers from the original images are not preserved or copied to the patched images."})})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},8453(e,n,i){i.d(n,{R:()=>r,x:()=>l});var t=i(6540);const a={},s=t.createContext(a);function r(e){const n=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);